<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyNAS Photo Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            text-align: center;
            color: #888;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 40px 20px;
            border: 3px dashed #ddd;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #888;
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-input-label.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .upload-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .upload-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            display: none;
        }

        .status.success {
            display: block;
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }

        .status.error {
            display: block;
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .nav-item {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 5px 15px;
            border-radius: 12px;
            transition: all 0.3s;
        }
        .nav-item.active {
            color: white;
            background: rgba(255,255,255,0.2);
        }

        /* ç…§ç‰‡ç½‘æ ¼ */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 10px 0;
        }
        @media (min-width: 768px) {
            .photos-grid { grid-template-columns: repeat(5, 1fr); }
        }
        .photo-item {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            background: #f0f0f0;
        }
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ç…§ç‰‡è¯¦æƒ… */
        .photo-detail {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
        }
        .photo-detail.active { display: flex; flex-direction: column; }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <nav class="bottom-nav">
        <a href="#upload" class="nav-item active" data-page="upload">&#128228; ä¸Šä¼ </a>
        <a href="#photos" class="nav-item" data-page="photos">&#128247; ç…§ç‰‡</a>
        <a href="#uploads" class="nav-item" data-page="uploads">&#128202; ä¼ è¾“</a>
        <a href="#admin" class="nav-item" data-page="admin">&#9881; ç®¡ç†</a>
    </nav>

    <script>
        // è·¯ç”±ç³»ç»Ÿ
        const routes = {
            'upload': renderUploadPage,
            'photos': renderPhotosPage,
            'uploads': renderUploadsPage,
            'admin': renderAdminPage
        };

        function navigate(page) {
            const container = document.getElementById('mainContainer');
            container.innerHTML = '';
            routes[page](container);
            updateNav(page);
        }

        function updateNav(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });
        }

        // ä¸Šä¼ é¡µé¢
        function renderUploadPage(container) {
            container.innerHTML = `
                <h1>&#9729; SkyNAS</h1>
                <p class="subtitle">åŒæ­¥ç…§ç‰‡åˆ° Mac</p>

                <form id="uploadForm">
                    <div class="form-group">
                        <label for="album">ç›¸å†Œåç§°</label>
                        <input type="text" id="album" name="album" placeholder="ä¾‹å¦‚ï¼šæ—…è¡Œã€ç”Ÿæ—¥" value="æœªåˆ†ç±»">
                    </div>

                    <div class="form-group">
                        <label>é€‰æ‹©ç…§ç‰‡</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="photos" name="photos" accept="image/*,video/*" multiple capture="environment">
                            <label for="photos" class="file-input-label">
                                <div>&#128204; ç‚¹å‡»é€‰æ‹©ç…§ç‰‡</div>
                                <div style="font-size: 12px; margin-top: 8px;">æ”¯æŒç…§ç‰‡å’Œè§†é¢‘</div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div id="fileList" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                    </div>

                    <button type="submit" class="upload-btn" id="uploadBtn">
                        å¼€å§‹åŒæ­¥
                    </button>
                </form>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>

                <div class="status" id="status"></div>
            `;

            // Initialize upload form handlers
            initUploadForm();
        }

        function initUploadForm() {
            const fileInput = document.getElementById('photos');
            const fileInputLabel = document.querySelector('.file-input-label');
            const fileList = document.getElementById('fileList');
            const form = document.getElementById('uploadForm');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const status = document.getElementById('status');

            let selectedFiles = [];

            fileInput.addEventListener('change', (e) => {
                selectedFiles = Array.from(e.target.files);
                if (selectedFiles.length > 0) {
                    fileInputLabel.classList.add('active');
                    fileInputLabel.innerHTML = `<div>&#9989; å·²é€‰æ‹© ${selectedFiles.length} ä¸ªæ–‡ä»¶</div>`;

                    const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
                    const sizeMB = (totalSize / 1024 / 1024).toFixed(1);
                    fileList.textContent = `æ€»å¤§å°: ${sizeMB} MB`;
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (selectedFiles.length === 0) {
                    showStatus('è¯·å…ˆé€‰æ‹©ç…§ç‰‡', 'error');
                    return;
                }

                uploadBtn.disabled = true;
                progressContainer.style.display = 'block';
                status.style.display = 'none';

                const album = document.getElementById('album').value || 'æœªåˆ†ç±»';
                let uploadedCount = 0;

                for (const file of selectedFiles) {
                    try {
                        await uploadFile(file, album, (progress) => {
                            const fileProgress = ((uploadedCount + progress) / selectedFiles.length) * 100;
                            progressFill.style.width = fileProgress + '%';
                            progressText.textContent = Math.round(fileProgress) + '%';
                        });
                        uploadedCount++;
                    } catch (err) {
                        showStatus(`ä¸Šä¼ å¤±è´¥: ${err.message}`, 'error');
                        uploadBtn.disabled = false;
                        return;
                    }
                }

                progressFill.style.width = '100%';
                progressText.textContent = 'å®Œæˆ!';
                showStatus(`æˆåŠŸåŒæ­¥ ${uploadedCount} ä¸ªæ–‡ä»¶`, 'success');

                // Reset form
                selectedFiles = [];
                fileInput.value = '';
                fileInputLabel.classList.remove('active');
                fileInputLabel.innerHTML = '<div>&#128204; ç‚¹å‡»é€‰æ‹©ç…§ç‰‡</div><div style="font-size: 12px; margin-top: 8px;">æ”¯æŒç…§ç‰‡å’Œè§†é¢‘</div>';
                fileList.textContent = '';
                uploadBtn.disabled = false;
            });

            async function uploadFile(file, album, onProgress) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('album', album);

                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();

                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            onProgress(e.loaded / e.total);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            resolve();
                        } else {
                            reject(new Error(xhr.responseText || 'ä¸Šä¼ å¤±è´¥'));
                        }
                    });

                    xhr.addEventListener('error', () => reject(new Error('ç½‘ç»œé”™è¯¯')));
                    xhr.addEventListener('abort', () => reject(new Error('ä¸Šä¼ å–æ¶ˆ')));

                    xhr.open('POST', '/api/upload');
                    xhr.send(formData);
                });
            }

            function showStatus(message, type) {
                status.textContent = message;
                status.className = 'status ' + type;
            }
        }

        // ç…§ç‰‡åˆ—è¡¨é¡µ
        async function renderPhotosPage(container) {
            container.innerHTML = `
                <div style="padding: 20px; padding-bottom: 80px;">
                    <h2 style="margin-bottom: 15px;">ç…§ç‰‡åº“</h2>
                    <select id="albumFilter" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; font-size: 16px;">
                        <option value="">å…¨éƒ¨ç›¸å†Œ</option>
                    </select>
                    <div id="photosGrid" class="photos-grid"></div>
                    <div id="loading" style="text-align: center; padding: 20px; color: #999;">åŠ è½½ä¸­...</div>
                </div>
            `;

            // åŠ è½½ç›¸å†Œåˆ—è¡¨
            try {
                const albums = await fetch('/api/albums').then(r => r.json());
                const select = document.getElementById('albumFilter');
                albums.forEach(album => {
                    select.innerHTML += `<option value="${album.name}">${album.name} (${album.count})</option>`;
                });

                select.addEventListener('change', () => {
                    currentPage = 1;
                    hasMore = true;
                    currentPhotos = [];
                    document.getElementById('photosGrid').innerHTML = '';
                    loadPhotos(select.value);
                });
            } catch (e) {
                console.error('åŠ è½½ç›¸å†Œå¤±è´¥:', e);
            }

            loadPhotos();
        }

        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        let currentPhotos = [];

        async function loadPhotos(album = '') {
            if (isLoading || !hasMore) return;
            isLoading = true;

            try {
                const url = `/api/photos?page=${currentPage}&limit=20${album ? '&album=' + encodeURIComponent(album) : ''}`;
                const data = await fetch(url).then(r => r.json());

                const grid = document.getElementById('photosGrid');

                data.photos.forEach(photo => {
                    const item = document.createElement('div');
                    item.className = 'photo-item';
                    item.innerHTML = photo.thumbnail_url
                        ? `<img src="${photo.thumbnail_url}" loading="lazy" alt="${photo.filename}">`
                        : `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 24px;">&#128247;</div>`;
                    item.addEventListener('click', () => openPhotoDetail(photo));
                    grid.appendChild(item);
                });

                currentPhotos.push(...data.photos);

                currentPage++;
                hasMore = data.photos.length === 20;

                if (!hasMore) {
                    document.getElementById('loading').textContent = 'æ²¡æœ‰æ›´å¤šç…§ç‰‡äº†';
                }
            } catch (e) {
                console.error('åŠ è½½ç…§ç‰‡å¤±è´¥:', e);
            } finally {
                isLoading = false;
            }
        }

        // ç…§ç‰‡è¯¦æƒ…é¡µ
        function openPhotoDetail(photo) {
            const detail = document.createElement('div');
            detail.className = 'photo-detail active';
            detail.innerHTML = `
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <img src="/api/photos/${photo.id}/image" style="max-width: 100%; max-height: 80vh; object-fit: contain;" alt="${photo.filename}">
                </div>
                <div style="background: white; padding: 20px; border-radius: 20px 20px 0 0;">
                    <h3 style="margin: 0 0 10px 0; word-break: break-all;">${photo.filename}</h3>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">
                        &#128193; ${photo.album} | &#128230; ${formatSize(photo.size_bytes)}
                        ${photo.width && photo.height ? `| &#9936; ${photo.width}x${photo.height}` : ''}
                    </p>
                    <p style="margin: 5px 0; color: #999; font-size: 12px;">
                        &#128197; ${new Date(photo.uploaded_at).toLocaleString()}
                    </p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="downloadPhoto(${photo.id}, '${photo.filename}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">ä¸‹è½½</button>
                        <button onclick="deletePhoto(${photo.id})" style="flex: 1; padding: 12px; background: #ff4444; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">åˆ é™¤</button>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer;">&#10005;</button>
            `;
            document.body.appendChild(detail);
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function downloadPhoto(id, filename) {
            const link = document.createElement('a');
            link.href = `/api/photos/${id}/image`;
            link.download = filename;
            link.click();
        }

        async function deletePhoto(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/photos/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    document.querySelector('.photo-detail.active')?.remove();
                    // Refresh photo list
                    currentPage = 1;
                    hasMore = true;
                    currentPhotos = [];
                    const grid = document.getElementById('photosGrid');
                    if (grid) {
                        grid.innerHTML = '';
                        const album = document.getElementById('albumFilter')?.value || '';
                        loadPhotos(album);
                    }
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                console.error('åˆ é™¤ç…§ç‰‡å¤±è´¥:', e);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // ä¼ è¾“çŠ¶æ€é¡µé¢
        let ws = null;
        let activeUploads = new Map();

        async function renderUploadsPage(container) {
            container.innerHTML = `
                <div style="padding: 20px; padding-bottom: 80px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">ä¼ è¾“çŠ¶æ€</h2>
                        <button id="cancelAllBtn" style="padding: 8px 16px; background: #ff4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            å–æ¶ˆæ‰€æœ‰
                        </button>
                    </div>
                    <div id="uploadsList" style="display: flex; flex-direction: column; gap: 15px;"></div>
                    <div id="emptyState" style="text-align: center; padding: 60px 20px; color: #999; display: none;">
                        <div style="font-size: 48px; margin-bottom: 10px;">&#128203;</div>
                        <p>å½“å‰æ²¡æœ‰ä¼ è¾“ä»»åŠ¡</p>
                    </div>
                    <button id="cleanupBtn" style="width: 100%; padding: 12px; margin-top: 20px; background: #666; color: white; border: none; border-radius: 10px; cursor: pointer; display: none;">
                        æ¸…ç†æœªå®Œæˆä¸Šä¼ å—
                    </button>
                </div>
            `;

            // åŠ è½½å½“å‰ä¼ è¾“ä»»åŠ¡
            await loadActiveUploads();

            // è¿æ¥ WebSocket å®æ—¶æ›´æ–°
            connectWebSocket();

            // ç»‘å®šå–æ¶ˆæ‰€æœ‰æŒ‰é’®
            document.getElementById('cancelAllBtn').addEventListener('click', async () => {
                if (!confirm('ç¡®å®šè¦å–æ¶ˆæ‰€æœ‰ä¼ è¾“ä»»åŠ¡å—ï¼Ÿ')) return;
                try {
                    const res = await fetch('/api/uploads/cancel-all', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        showToast(`å·²å–æ¶ˆ ${data.cancelled_count} ä¸ªä»»åŠ¡`);
                    }
                } catch (e) {
                    showToast('å–æ¶ˆå¤±è´¥: ' + e.message, 'error');
                }
            });

            // ç»‘å®šæ¸…ç†æŒ‰é’®ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
            document.getElementById('cleanupBtn').addEventListener('click', async () => {
                if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æœªå®Œæˆçš„ä¸Šä¼ å—å—ï¼Ÿ')) return;
                try {
                    const res = await fetch('/api/uploads/cleanup-incomplete', { method: 'DELETE' });
                    const data = await res.json();
                    if (data.success) {
                        showToast(`æ¸…ç†å®Œæˆï¼Œé‡Šæ”¾ ${formatSize(data.freed_bytes)}`);
                    }
                } catch (e) {
                    showToast('æ¸…ç†å¤±è´¥: ' + e.message, 'error');
                }
            });
        }

        async function loadActiveUploads() {
            try {
                const res = await fetch('/api/uploads/active');
                const uploads = await res.json();

                uploads.forEach(upload => {
                    activeUploads.set(upload.id, upload);
                });

                renderUploadsList();
            } catch (e) {
                console.error('åŠ è½½ä¼ è¾“ä»»åŠ¡å¤±è´¥:', e);
            }
        }

        function renderUploadsList() {
            const list = document.getElementById('uploadsList');
            const emptyState = document.getElementById('emptyState');

            if (activeUploads.size === 0) {
                list.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            list.innerHTML = '';

            activeUploads.forEach(upload => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: 500; margin-bottom: 4px;">${upload.filename}</div>
                            <div style="font-size: 12px; color: #666;">&#128193; ${upload.album}</div>
                        </div>
                        <button onclick="cancelUpload('${upload.id}')" style="padding: 6px 12px; background: #ff4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            å–æ¶ˆ
                        </button>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 4px;">
                            <span>${upload.status === 'uploading' ? 'ä¸Šä¼ ä¸­...' : 'ç­‰å¾…ä¸­'}</span>
                            <span>${upload.progress_percent}% (${formatSize(upload.received_bytes)} / ${formatSize(upload.total_bytes)})</span>
                        </div>
                        <div style="height: 6px; background: #eee; border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: ${upload.progress_percent}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        async function cancelUpload(id) {
            try {
                const res = await fetch(`/api/uploads/${id}/cancel`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    activeUploads.delete(id);
                    renderUploadsList();
                    showToast('å·²å–æ¶ˆä¸Šä¼ ');
                }
            } catch (e) {
                showToast('å–æ¶ˆå¤±è´¥: ' + e.message, 'error');
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                switch (data.type) {
                    case 'UploadStarted':
                        activeUploads.set(data.upload_id, {
                            id: data.upload_id,
                            filename: data.filename,
                            album: data.album,
                            total_bytes: data.total_bytes,
                            received_bytes: 0,
                            progress_percent: 0,
                            status: 'uploading'
                        });
                        renderUploadsList();
                        break;

                    case 'UploadProgress':
                        const upload = activeUploads.get(data.upload_id);
                        if (upload) {
                            upload.received_bytes = data.received_bytes;
                            upload.progress_percent = data.percent;
                            renderUploadsList();
                        }
                        break;

                    case 'UploadComplete':
                        activeUploads.delete(data.upload_id);
                        renderUploadsList();
                        showToast(`${data.filename} ä¸Šä¼ å®Œæˆ`);
                        // å¦‚æœåœ¨ç…§ç‰‡é¡µé¢ï¼Œåˆ·æ–°åˆ—è¡¨
                        if (location.hash === '#photos') {
                            loadPhotos();
                        }
                        break;

                    case 'UploadError':
                        activeUploads.delete(data.upload_id);
                        renderUploadsList();
                        showToast(`${data.filename} ä¸Šä¼ å¤±è´¥: ${data.error}`, 'error');
                        break;
                }
            };

            ws.onclose = () => {
                // 3ç§’åé‡æ–°è¿æ¥
                setTimeout(connectWebSocket, 3000);
            };
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                background: ${type === 'error' ? '#ff4444' : '#4CAF50'};
                color: white;
                border-radius: 8px;
                font-size: 14px;
                z-index: 3000;
                animation: fadeIn 0.3s;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateX(-50%) translateY(20px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // ç®¡ç†åå°
        let adminToken = localStorage.getItem('adminToken');

        function renderAdminPage(container) {
            if (!adminToken) {
                renderLoginPage(container);
            } else {
                renderAdminDashboard(container);
            }
        }

        // ç™»å½•é¡µé¢
        function renderLoginPage(container) {
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 20px;">
                    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px;">
                        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">ç®¡ç†åå°ç™»å½•</h2>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-size: 14px;">å¯†ç </label>
                            <div style="position: relative;">
                                <input type="password" id="adminPassword" placeholder="è¾“å…¥ç®¡ç†å¯†ç "
                                    style="width: 100%; padding: 14px 50px 14px 14px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; box-sizing: border-box;">
                                <button id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px;">
                                    ğŸ‘ï¸
                                </button>
                            </div>
                        </div>
                        <div id="loginError" style="color: #ff4444; font-size: 14px; margin-bottom: 15px; display: none;"></div>
                        <button id="loginBtn" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer;">
                            ç™» å½•
                        </button>
                    </div>
                </div>
            `;

            // å¯†ç æ˜¾ç¤ºåˆ‡æ¢
            const passwordInput = document.getElementById('adminPassword');
            const toggleBtn = document.getElementById('togglePassword');

            toggleBtn.addEventListener('click', () => {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleBtn.textContent = 'ğŸ™ˆ';
                } else {
                    passwordInput.type = 'password';
                    toggleBtn.textContent = 'ğŸ‘ï¸';
                }
            });

            // ç™»å½•æŒ‰é’®
            document.getElementById('loginBtn').addEventListener('click', async () => {
                const password = passwordInput.value;
                if (!password) {
                    showLoginError('è¯·è¾“å…¥å¯†ç ');
                    return;
                }

                try {
                    const res = await fetch('/api/admin/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });

                    if (res.ok) {
                        const data = await res.json();
                        adminToken = data.token;
                        localStorage.setItem('adminToken', adminToken);
                        localStorage.setItem('tokenExpires', data.expires_at);
                        renderAdminDashboard(container);
                    } else {
                        showLoginError('å¯†ç é”™è¯¯');
                    }
                } catch (e) {
                    showLoginError('ç™»å½•å¤±è´¥: ' + e.message);
                }
            });
        }

        function showLoginError(msg) {
            const err = document.getElementById('loginError');
            err.textContent = msg;
            err.style.display = 'block';
        }

        // ç®¡ç†é¦–é¡µ
        async function renderAdminDashboard(container) {
            container.innerHTML = `
                <div style="padding: 20px; padding-bottom: 80px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">ç®¡ç†åå°</h2>
                        <button id="logoutBtn" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            é€€å‡ºç™»å½•
                        </button>
                    </div>

                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div id="statsCards" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 16px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold;" id="totalPhotos">-</div>
                            <div style="font-size: 14px; opacity: 0.9;">æ€»ç…§ç‰‡æ•°</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 16px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold;" id="totalSize">-</div>
                            <div style="font-size: 14px; opacity: 0.9;">æ€»å­˜å‚¨</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 20px; border-radius: 16px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold;" id="albumCount">-</div>
                            <div style="font-size: 14px; opacity: 0.9;">ç›¸å†Œæ•°</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; padding: 20px; border-radius: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;" id="systemStatus">ğŸŸ¢</div>
                            <div style="font-size: 14px; opacity: 0.9;">ç³»ç»ŸçŠ¶æ€</div>
                        </div>
                    </div>

                    <!-- é…ç½®å¡ç‰‡ -->
                    <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 20px 0;">é…ç½®ç®¡ç†</h3>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-size: 14px;">å­˜å‚¨è·¯å¾„</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="storagePath" readonly
                                    style="flex: 1; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f5f5f5;">
                                <button id="validatePathBtn" style="padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    éªŒè¯
                                </button>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-size: 14px;">æœåŠ¡ç«¯å£</label>
                            <input type="text" id="serverPort" readonly
                                style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f5f5f5; box-sizing: border-box;">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-size: 14px;">åŠŸèƒ½å¼€å…³</label>
                            <div id="featureToggles" style="display: flex; flex-direction: column; gap: 10px;"></div>
                        </div>

                        <button id="saveConfigBtn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer;">
                            ä¿å­˜é…ç½®ï¼ˆéœ€é‡å¯æœåŠ¡å™¨ï¼‰
                        </button>
                    </div>
                </div>
            `;

            // åŠ è½½ç»Ÿè®¡æ•°æ®
            loadStats();

            // åŠ è½½é…ç½®
            loadConfig();

            // é€€å‡ºç™»å½•
            document.getElementById('logoutBtn').addEventListener('click', () => {
                adminToken = null;
                localStorage.removeItem('adminToken');
                localStorage.removeItem('tokenExpires');
                renderLoginPage(container);
            });

            // éªŒè¯è·¯å¾„
            document.getElementById('validatePathBtn').addEventListener('click', async () => {
                const path = document.getElementById('storagePath').value;
                try {
                    const res = await fetchWithAuth('/api/admin/config/validate-storage', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ storage_path: path })
                    });
                    const data = await res.json();
                    if (data.valid) {
                        showToast('è·¯å¾„æœ‰æ•ˆä¸”å¯å†™');
                    } else {
                        showToast(`è·¯å¾„æ— æ•ˆ: ${data.exists ? 'ä¸å¯å†™' : 'ä¸å­˜åœ¨'}`, 'error');
                    }
                } catch (e) {
                    showToast('éªŒè¯å¤±è´¥', 'error');
                }
            });

            // ä¿å­˜é…ç½®
            document.getElementById('saveConfigBtn').addEventListener('click', () => {
                showToast('é…ç½®å·²ä¿å­˜ï¼Œè¯·é‡å¯æœåŠ¡å™¨ç”Ÿæ•ˆ');
            });
        }

        async function loadStats() {
            try {
                const res = await fetchWithAuth('/api/admin/stats');
                const stats = await res.json();

                document.getElementById('totalPhotos').textContent = stats.total_photos.toLocaleString();
                document.getElementById('totalSize').textContent = formatSize(stats.total_size);
                document.getElementById('albumCount').textContent = stats.album_count.toLocaleString();
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
            }
        }

        async function loadConfig() {
            try {
                const res = await fetchWithAuth('/api/admin/config');
                const config = await res.json();

                document.getElementById('storagePath').value = config.storage_path;
                document.getElementById('serverPort').value = `${config.server_host}:${config.server_port}`;

                const toggles = document.getElementById('featureToggles');
                const features = [
                    { key: 'mdns_enabled', label: 'mDNS æœåŠ¡å‘ç°' },
                    { key: 'websocket_enabled', label: 'WebSocket å®æ—¶é€šçŸ¥' },
                    { key: 'heic_to_jpeg', label: 'HEIC è‡ªåŠ¨è½¬ JPEG' },
                    { key: 'notification_enabled', label: 'ç³»ç»Ÿé€šçŸ¥' }
                ];

                toggles.innerHTML = features.map(f => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                        <span>${f.label}</span>
                        <span style="color: ${config.features[f.key] ? '#4CAF50' : '#999'}; font-weight: bold;">
                            ${config.features[f.key] ? 'âœ“ å¼€å¯' : 'âœ— å…³é—­'}
                        </span>
                    </div>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
            }
        }

        // å¸¦è®¤è¯çš„è¯·æ±‚
        async function fetchWithAuth(url, options = {}) {
            if (!adminToken) {
                throw new Error('æœªç™»å½•');
            }

            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${adminToken}`
            };

            const res = await fetch(url, options);

            if (res.status === 401) {
                // Token è¿‡æœŸ
                adminToken = null;
                localStorage.removeItem('adminToken');
                location.reload();
                throw new Error('ç™»å½•å·²è¿‡æœŸ');
            }

            return res;
        }

        // åˆå§‹åŒ–è·¯ç”±
        window.addEventListener('hashchange', () => {
            const page = location.hash.slice(1) || 'upload';
            navigate(page);
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const page = location.hash.slice(1) || 'upload';
            navigate(page);
        });
    </script>
</body>
</html>
