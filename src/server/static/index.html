<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyNAS Photo Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            text-align: center;
            color: #888;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 40px 20px;
            border: 3px dashed #ddd;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #888;
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-input-label.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .upload-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .upload-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            display: none;
        }

        .status.success {
            display: block;
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }

        .status.error {
            display: block;
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .nav-item {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 5px 15px;
            border-radius: 12px;
            transition: all 0.3s;
        }
        .nav-item.active {
            color: white;
            background: rgba(255,255,255,0.2);
        }

        /* 照片网格 */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 10px 0;
        }
        @media (min-width: 768px) {
            .photos-grid { grid-template-columns: repeat(5, 1fr); }
        }
        .photo-item {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            background: #f0f0f0;
        }
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 照片详情 */
        .photo-detail {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
        }
        .photo-detail.active { display: flex; flex-direction: column; }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <nav class="bottom-nav">
        <a href="#upload" class="nav-item active" data-page="upload">&#128228; 上传</a>
        <a href="#photos" class="nav-item" data-page="photos">&#128247; 照片</a>
        <a href="#uploads" class="nav-item" data-page="uploads">&#128202; 传输</a>
        <a href="#admin" class="nav-item" data-page="admin">&#9881; 管理</a>
    </nav>

    <script>
        // 路由系统
        const routes = {
            'upload': renderUploadPage,
            'photos': renderPhotosPage,
            'uploads': renderUploadsPage,
            'admin': renderAdminPage
        };

        function navigate(page) {
            const container = document.getElementById('mainContainer');
            container.innerHTML = '';
            routes[page](container);
            updateNav(page);
        }

        function updateNav(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });
        }

        // 上传页面
        function renderUploadPage(container) {
            container.innerHTML = `
                <h1>&#9729; SkyNAS</h1>
                <p class="subtitle">同步照片到 Mac</p>

                <form id="uploadForm">
                    <div class="form-group">
                        <label for="album">相册名称</label>
                        <input type="text" id="album" name="album" placeholder="例如：旅行、生日" value="未分类">
                    </div>

                    <div class="form-group">
                        <label>选择照片</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="photos" name="photos" accept="image/*,video/*" multiple capture="environment">
                            <label for="photos" class="file-input-label">
                                <div>&#128204; 点击选择照片</div>
                                <div style="font-size: 12px; margin-top: 8px;">支持照片和视频</div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div id="fileList" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                    </div>

                    <button type="submit" class="upload-btn" id="uploadBtn">
                        开始同步
                    </button>
                </form>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>

                <div class="status" id="status"></div>
            `;

            // Initialize upload form handlers
            initUploadForm();
        }

        function initUploadForm() {
            const fileInput = document.getElementById('photos');
            const fileInputLabel = document.querySelector('.file-input-label');
            const fileList = document.getElementById('fileList');
            const form = document.getElementById('uploadForm');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const status = document.getElementById('status');

            let selectedFiles = [];

            fileInput.addEventListener('change', (e) => {
                selectedFiles = Array.from(e.target.files);
                if (selectedFiles.length > 0) {
                    fileInputLabel.classList.add('active');
                    fileInputLabel.innerHTML = `<div>&#9989; 已选择 ${selectedFiles.length} 个文件</div>`;

                    const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
                    const sizeMB = (totalSize / 1024 / 1024).toFixed(1);
                    fileList.textContent = `总大小: ${sizeMB} MB`;
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (selectedFiles.length === 0) {
                    showStatus('请先选择照片', 'error');
                    return;
                }

                uploadBtn.disabled = true;
                progressContainer.style.display = 'block';
                status.style.display = 'none';

                const album = document.getElementById('album').value || '未分类';
                let uploadedCount = 0;

                for (const file of selectedFiles) {
                    try {
                        await uploadFile(file, album, (progress) => {
                            const fileProgress = ((uploadedCount + progress) / selectedFiles.length) * 100;
                            progressFill.style.width = fileProgress + '%';
                            progressText.textContent = Math.round(fileProgress) + '%';
                        });
                        uploadedCount++;
                    } catch (err) {
                        showStatus(`上传失败: ${err.message}`, 'error');
                        uploadBtn.disabled = false;
                        return;
                    }
                }

                progressFill.style.width = '100%';
                progressText.textContent = '完成!';
                showStatus(`成功同步 ${uploadedCount} 个文件`, 'success');

                // Reset form
                selectedFiles = [];
                fileInput.value = '';
                fileInputLabel.classList.remove('active');
                fileInputLabel.innerHTML = '<div>&#128204; 点击选择照片</div><div style="font-size: 12px; margin-top: 8px;">支持照片和视频</div>';
                fileList.textContent = '';
                uploadBtn.disabled = false;
            });

            async function uploadFile(file, album, onProgress) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('album', album);

                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();

                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            onProgress(e.loaded / e.total);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            resolve();
                        } else {
                            reject(new Error(xhr.responseText || '上传失败'));
                        }
                    });

                    xhr.addEventListener('error', () => reject(new Error('网络错误')));
                    xhr.addEventListener('abort', () => reject(new Error('上传取消')));

                    xhr.open('POST', '/api/upload');
                    xhr.send(formData);
                });
            }

            function showStatus(message, type) {
                status.textContent = message;
                status.className = 'status ' + type;
            }
        }

        // 照片列表页
        async function renderPhotosPage(container) {
            container.innerHTML = `
                <div style="padding: 20px; padding-bottom: 80px;">
                    <h2 style="margin-bottom: 15px;">照片库</h2>
                    <select id="albumFilter" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; font-size: 16px;">
                        <option value="">全部相册</option>
                    </select>
                    <div id="photosGrid" class="photos-grid"></div>
                    <div id="loading" style="text-align: center; padding: 20px; color: #999;">加载中...</div>
                </div>
            `;

            // 加载相册列表
            try {
                const albums = await fetch('/api/albums').then(r => r.json());
                const select = document.getElementById('albumFilter');
                albums.forEach(album => {
                    select.innerHTML += `<option value="${album.name}">${album.name} (${album.count})</option>`;
                });

                select.addEventListener('change', () => {
                    currentPage = 1;
                    hasMore = true;
                    currentPhotos = [];
                    document.getElementById('photosGrid').innerHTML = '';
                    loadPhotos(select.value);
                });
            } catch (e) {
                console.error('加载相册失败:', e);
            }

            loadPhotos();
        }

        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        let currentPhotos = [];

        async function loadPhotos(album = '') {
            if (isLoading || !hasMore) return;
            isLoading = true;

            try {
                const url = `/api/photos?page=${currentPage}&limit=20${album ? '&album=' + encodeURIComponent(album) : ''}`;
                const data = await fetch(url).then(r => r.json());

                const grid = document.getElementById('photosGrid');

                data.photos.forEach(photo => {
                    const item = document.createElement('div');
                    item.className = 'photo-item';
                    item.innerHTML = photo.thumbnail_url
                        ? `<img src="${photo.thumbnail_url}" loading="lazy" alt="${photo.filename}">`
                        : `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 24px;">&#128247;</div>`;
                    item.addEventListener('click', () => openPhotoDetail(photo));
                    grid.appendChild(item);
                });

                currentPhotos.push(...data.photos);

                currentPage++;
                hasMore = data.photos.length === 20;

                if (!hasMore) {
                    document.getElementById('loading').textContent = '没有更多照片了';
                }
            } catch (e) {
                console.error('加载照片失败:', e);
            } finally {
                isLoading = false;
            }
        }

        // 照片详情页
        function openPhotoDetail(photo) {
            const detail = document.createElement('div');
            detail.className = 'photo-detail active';
            detail.innerHTML = `
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <img src="/api/photos/${photo.id}/image" style="max-width: 100%; max-height: 80vh; object-fit: contain;" alt="${photo.filename}">
                </div>
                <div style="background: white; padding: 20px; border-radius: 20px 20px 0 0;">
                    <h3 style="margin: 0 0 10px 0; word-break: break-all;">${photo.filename}</h3>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">
                        &#128193; ${photo.album} | &#128230; ${formatSize(photo.size_bytes)}
                        ${photo.width && photo.height ? `| &#9936; ${photo.width}x${photo.height}` : ''}
                    </p>
                    <p style="margin: 5px 0; color: #999; font-size: 12px;">
                        &#128197; ${new Date(photo.uploaded_at).toLocaleString()}
                    </p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="downloadPhoto(${photo.id}, '${photo.filename}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">下载</button>
                        <button onclick="deletePhoto(${photo.id})" style="flex: 1; padding: 12px; background: #ff4444; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;">删除</button>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer;">&#10005;</button>
            `;
            document.body.appendChild(detail);
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function downloadPhoto(id, filename) {
            const link = document.createElement('a');
            link.href = `/api/photos/${id}/image`;
            link.download = filename;
            link.click();
        }

        async function deletePhoto(id) {
            if (!confirm('确定要删除这张照片吗？')) return;

            try {
                const response = await fetch(`/api/photos/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    document.querySelector('.photo-detail.active')?.remove();
                    // Refresh photo list
                    currentPage = 1;
                    hasMore = true;
                    currentPhotos = [];
                    const grid = document.getElementById('photosGrid');
                    if (grid) {
                        grid.innerHTML = '';
                        const album = document.getElementById('albumFilter')?.value || '';
                        loadPhotos(album);
                    }
                } else {
                    alert('删除失败');
                }
            } catch (e) {
                console.error('删除照片失败:', e);
                alert('删除失败');
            }
        }

        // 传输状态页面
        let ws = null;
        let activeUploads = new Map();

        async function renderUploadsPage(container) {
            container.innerHTML = `
                <div style="padding: 20px; padding-bottom: 80px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">传输状态</h2>
                        <button id="cancelAllBtn" style="padding: 8px 16px; background: #ff4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            取消所有
                        </button>
                    </div>
                    <div id="uploadsList" style="display: flex; flex-direction: column; gap: 15px;"></div>
                    <div id="emptyState" style="text-align: center; padding: 60px 20px; color: #999; display: none;">
                        <div style="font-size: 48px; margin-bottom: 10px;">&#128203;</div>
                        <p>当前没有传输任务</p>
                    </div>
                    <button id="cleanupBtn" style="width: 100%; padding: 12px; margin-top: 20px; background: #666; color: white; border: none; border-radius: 10px; cursor: pointer; display: none;">
                        清理未完成上传块
                    </button>
                </div>
            `;

            // 加载当前传输任务
            await loadActiveUploads();

            // 连接 WebSocket 实时更新
            connectWebSocket();

            // 绑定取消所有按钮
            document.getElementById('cancelAllBtn').addEventListener('click', async () => {
                if (!confirm('确定要取消所有传输任务吗？')) return;
                try {
                    const res = await fetch('/api/uploads/cancel-all', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        showToast(`已取消 ${data.cancelled_count} 个任务`);
                    }
                } catch (e) {
                    showToast('取消失败: ' + e.message, 'error');
                }
            });

            // 绑定清理按钮（仅管理员可见）
            document.getElementById('cleanupBtn').addEventListener('click', async () => {
                if (!confirm('确定要清理所有未完成的上传块吗？')) return;
                try {
                    const res = await fetch('/api/uploads/cleanup-incomplete', { method: 'DELETE' });
                    const data = await res.json();
                    if (data.success) {
                        showToast(`清理完成，释放 ${formatSize(data.freed_bytes)}`);
                    }
                } catch (e) {
                    showToast('清理失败: ' + e.message, 'error');
                }
            });
        }

        async function loadActiveUploads() {
            try {
                const res = await fetch('/api/uploads/active');
                const uploads = await res.json();

                uploads.forEach(upload => {
                    activeUploads.set(upload.id, upload);
                });

                renderUploadsList();
            } catch (e) {
                console.error('加载传输任务失败:', e);
            }
        }

        function renderUploadsList() {
            const list = document.getElementById('uploadsList');
            const emptyState = document.getElementById('emptyState');

            if (activeUploads.size === 0) {
                list.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            list.innerHTML = '';

            activeUploads.forEach(upload => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: 500; margin-bottom: 4px;">${upload.filename}</div>
                            <div style="font-size: 12px; color: #666;">&#128193; ${upload.album}</div>
                        </div>
                        <button onclick="cancelUpload('${upload.id}')" style="padding: 6px 12px; background: #ff4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            取消
                        </button>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 4px;">
                            <span>${upload.status === 'uploading' ? '上传中...' : '等待中'}</span>
                            <span>${upload.progress_percent}% (${formatSize(upload.received_bytes)} / ${formatSize(upload.total_bytes)})</span>
                        </div>
                        <div style="height: 6px; background: #eee; border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: ${upload.progress_percent}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        async function cancelUpload(id) {
            try {
                const res = await fetch(`/api/uploads/${id}/cancel`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    activeUploads.delete(id);
                    renderUploadsList();
                    showToast('已取消上传');
                }
            } catch (e) {
                showToast('取消失败: ' + e.message, 'error');
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                switch (data.type) {
                    case 'UploadStarted':
                        activeUploads.set(data.upload_id, {
                            id: data.upload_id,
                            filename: data.filename,
                            album: data.album,
                            total_bytes: data.total_bytes,
                            received_bytes: 0,
                            progress_percent: 0,
                            status: 'uploading'
                        });
                        renderUploadsList();
                        break;

                    case 'UploadProgress':
                        const upload = activeUploads.get(data.upload_id);
                        if (upload) {
                            upload.received_bytes = data.received_bytes;
                            upload.progress_percent = data.percent;
                            renderUploadsList();
                        }
                        break;

                    case 'UploadComplete':
                        activeUploads.delete(data.upload_id);
                        renderUploadsList();
                        showToast(`${data.filename} 上传完成`);
                        // 如果在照片页面，刷新列表
                        if (location.hash === '#photos') {
                            loadPhotos();
                        }
                        break;

                    case 'UploadError':
                        activeUploads.delete(data.upload_id);
                        renderUploadsList();
                        showToast(`${data.filename} 上传失败: ${data.error}`, 'error');
                        break;
                }
            };

            ws.onclose = () => {
                // 3秒后重新连接
                setTimeout(connectWebSocket, 3000);
            };
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                background: ${type === 'error' ? '#ff4444' : '#4CAF50'};
                color: white;
                border-radius: 8px;
                font-size: 14px;
                z-index: 3000;
                animation: fadeIn 0.3s;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateX(-50%) translateY(20px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        function renderAdminPage(container) {
            container.innerHTML = '<div style="padding: 20px;"><h2>管理后台</h2><p>开发中...</p></div>';
        }

        // 初始化路由
        window.addEventListener('hashchange', () => {
            const page = location.hash.slice(1) || 'upload';
            navigate(page);
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            const page = location.hash.slice(1) || 'upload';
            navigate(page);
        });
    </script>
</body>
</html>
